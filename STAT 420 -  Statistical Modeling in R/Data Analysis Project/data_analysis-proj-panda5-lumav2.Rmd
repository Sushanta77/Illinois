---
title: 'Data Analysis Project - STAT 420 - Group Project'
author: "Luma Vasiljevic(lumav2), Sushanta Panda(panda5)"
date: 
output:
  html_document:
    theme: flatly
    toc: yes
    fig_width: 10
    fig_height: 5
  pdf_document:
    toc: yes
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
options(scipen = 1, digits = 4, width = 80)
library(knitr)
opts_chunk$set(cache = TRUE, autodep = TRUE)
```

# Introduction


###Description of the dataset:
Forced Expiratory Volume (FEV) is an index of pulmonary function that measures the volume of the air expelled after one second of constant effort. The data contains the determinations of FEB on 654 children ages 6 – 22 who are seen in childhood respiratory disease study in 1980 in East Boston, Massachusetts. The data are part of a larger study to follow the change in pulmonary function over time in children.

#####**Dataset Link: **
http://www.statsci.org/data/general/fev.html

#####**Variables in the Dataset:**

```{r include=FALSE}
Variable = data.frame(
  VariableName = c("ID","Age", "Height", "Sex", "Smoker", "FEV"),
  Category = c("Numeric","Numeric", "Numeric", "Categorical", "Categorical", "Numeric"),
  Description = c("Uniquely Identified Row","Age of the child", "Height of the child in inches", "Sex of the child ", "Whether the child is a non-smoker or current smoker", "FEV of the child in litres")
)
```


```{r echo=FALSE}
library(knitr)
kable(Variable, format = "pandoc",padding = 2)
```

#####**Background information of the dataset:**

The data contains the determinations of FEB on 654 children ages 6 – 22 who are seen in childhood respiratory disease study in 1980 in East Boston, Massachusetts. The data are part of a larger study to follow the change in pulmonary function over time in children

Note: No citation required for this source (http://www.statsci.org/data/general/fev.html)


###Why is it interesting:
This dataset has chosen by us because of personal interests, whether we can predict the child’s FEV with the help of the available predictor, rather going for a Pulmonary Function Test, which will identify any pulmonary disease of a child. And secondly, to do statistical analysis on what are the predictors responsible to increase / decrease the pulmonary function of the child and try to find answer on these lines.

###Why are we creating a model of this Data:
In order to **predict the child's Forced Exporatory Volume (FEV)** based on the Child's Age, Height, Sex and whether the child is a smoker or not. This will help for kick-start the treatment of the child based on the FEV reading, rather going throgh the Pulmonary Function test.


###Goal of the Model:
The goal of the model is to find the best model after going through the several methods, which predict the child's FEV with minimal error. The best model would have the lowest Root Mean Square Error (RMSE) against Leave One Out cross validation (LOOCV).


# Methods
We will be doing several data analysis and methods in this section, where each section will be describing what's the part of the tasks.

###Load FEV data, Observations:

```{r}
childfev = read.csv("http://www.statsci.org/data/general/fev.txt",
                    sep = "\t",
                    quote = "\"",
                    comment.char = "",
                    stringsAsFactors = FALSE)
childfev$Sex = as.factor(childfev$Sex)
childfev$Smoker = as.factor(childfev$Smoker)
str(childfev)
dim(childfev)
head(childfev$FEV,10)
```

From the dataset, it observered data, Age, Heigh is a numerical variable, where as Sex / Smoker field is a categorical variable. The FEV is the numerical **response** variable.


#####**Load FEV data:**
```{r fig.height=10, fig.width=10}
pairs(childfev[c('Age','FEV','Height','Sex','Smoker')], col = "darkgrey")
```

From the pairs plot, it sees there is a clear signs of linear releationship between FEV and Height. However there is no clear sign of linear relationship between FEV and Age variable. The 2 categorical variable `Sex` and `Smoker` seems to have 2 distinct data. Let's explore this

**Let's check the Correlation Matrix to explore what's the co-relation among the variables**
```{r}
cor(childfev[c('Age','Height','FEV')])
```
It seems that what the pair plot shows seems correct, from the corelation matrix it also suggests that `Age` and `Height` are higly corelation with `FEV` response, as well as among it self,  We need to explore the variance inflation factor (VIF) while creating our model in further.


#####**Categorical Data of Sex and Smoker**
```{r}
table(childfev$Sex)
table(childfev$Smoker)
```

###MLR FEV data:
Let's start with the Multiple Linear Regression (MLR) against all the predictor (Except the ID), to predict the FEV as the response

```{r}
mlr_model = lm(FEV ~ Age + Height + Sex + Smoker, data = childfev)
summary(mlr_model)
```

#####**Assumption of the Model**
Let's verify the Assumption of the Model
 - Constant Varience
 - Normality 

**Let's plot Plotted Versus Residul Plot to see the distribution**
```{r}
par(mfrow = c(1,2))
plot(resid(mlr_model)~fitted(mlr_model), ylab = "residuals", xlab = "fitted", cex = 1, pch = 1, col = "darkgrey", main = "Residuals Versis Fitted Model")
abline(h = 0, lwd = 2, col = "darkorange")

qqnorm(resid(mlr_model), cex = 1, pch = 1, col = "darkgrey")
qqline(resid(mlr_model), lwd = 2, col = "darkorange")
```

From the above residuals versus fitted plot, it seems the **constant variance assumption is suspect**, as the residuals are not equally distributed. 

This is the same case for the Q-Q plot, where both the tail seems to the a little fat tails, which tells us that **normality assuption seems suspect** for the model.

Let's do the BP Test and Shapiro Test to gather some more evidence

```{r warning=FALSE}
bptest(mlr_model)
```

The BP Test is very low which confirms that **constant variance is suspect**

```{r}
shapiro.test(resid(mlr_model))
```

The shapiro test also seems lkow, which confirms that the **normality assumption also seems suspect**

#####**RSS, RMSE and RMSE LOOCV**
Let'e calculate the RSS, RMSE and RMSE LOOCV of the model
**RSS**
```{r}
sum((resid(mlr_model))^2)
```

**RMSE**
```{r}
sqrt(mean(sum((resid(mlr_model))^2)))
```

**RMSE LOOCV**
```{r}
sqrt(mean((resid(mlr_model)/(1-hatvalues(mlr_model)))^2))
```

```{r include=FALSE}
mlr_model = data.frame(
  Metric = c("RSS","RMSE", "RMSE LOOCV"),
  Value = c(sum((resid(mlr_model))^2),sqrt(mean(sum((resid(mlr_model))^2))),sqrt(mean((resid(mlr_model)/(1-hatvalues(mlr_model)))^2)))
)
```

```{r echo=FALSE}
library(knitr)
kable(mlr_model, format = "pandoc",padding = 2)
```

###Transformation of FEV (Logarithimic):
Let's explore whether transformation of the response variable `FEV` has any siginificance to improve the score (low RMSE LOOCV)


Let's first plot the histogram of the `FEV` response variable with and without the logarathimic value

```{r}
par(mfrow=c(1,2))
hist(childfev$FEV,
     xlab = 'FEV response Variable Data',
     probability = TRUE,
     breaks = 20,
     col = "darkgrey",
     name = "Original FEV response")

hist(log(childfev$FEV),
     xlab = 'log(FEV) response Variable Data',     
     breaks = 20,
     col = "darkgrey",
     name = "Logarithimic FEV response")
```

It seems that after the logarithimic transformation the `FEV` response doesn't seems to be normal distibution. Hence let's not explore the lograthimic transformation for the `FEV` response variable

###Transformation of FEV (Polynomial):
Let's explore the polynomial transformation of the predictor to see whether we can able to find the best model which lower the RMSE LOOCV

#####**quadriatic Transformation of the Numerical Predictors:**

```{r}
quad_model = lm(FEV ~ Age + Height + Sex + Smoker + I(Age ^ 2) + I(Height ^ 2), data = childfev)
summary(quad_model)
```

It seems the quadratic model is significance with low p value **<2e-16**, including all the predictors are significance though except `Age` where the p value is around `r summary(quad_model)$coefficientp[2,4]`

Let's check the Assumption of the model

#####**Assumption of the Model**
Let's verify the Assumption of the Model
 - Constant Varience
 - Normality 

**Let's plot Plotted Versus Residul Plot to see the distribution**
```{r}
par(mfrow = c(1,2))
plot(resid(quad_model)~fitted(quad_model), ylab = "residuals", xlab = "fitted", cex = 1, pch = 1, col = "darkgrey", main = "Residuals Versis Fitted Model - Quad")
abline(h = 0, lwd = 2, col = "darkorange")

qqnorm(resid(quad_model), cex = 1, pch = 1, col = "darkgrey")
qqline(resid(quad_model), lwd = 2, col = "darkorange")
```

From the above residuals versus fitted plot, though it seems better than that of **Multiple Linear Regression**, it's not doing good job for the higher fitted values. It seems as the fitted value goes higher, the residual seems to be wider, hence the **constant variance assumption is suspect**

This is the same case for the Q-Q plot, where both the tail seems to the a little fat tails, which tells us that **normality assuption seems suspect** for the model.

Let's do the BP Test and Shapiro Test to gather some more evidence

```{r warning=FALSE}
bptest(quad_model)
```

The BP Test is very low which confirms that **constant variance is suspect**

```{r}
shapiro.test(resid(quad_model))
```

The shapiro test also seems lkow, which confirms that the **normality assumption also seems suspect**

#####**RSS, RMSE and RMSE LOOCV**
Let'e calculate the RSS, RMSE and RMSE LOOCV of the model
**RSS**
```{r}
sum((resid(quad_model))^2)
```

**RMSE**
```{r}
sqrt(mean(sum((resid(quad_model))^2)))
```

**RMSE LOOCV**
```{r}
sqrt(mean((resid(quad_model)/(1-hatvalues(quad_model)))^2))
```

```{r include=FALSE}
quad_model = data.frame(
  Metric = c("RSS","RMSE", "RMSE LOOCV"),
  Value = c(sum((resid(quad_model))^2),sqrt(mean(sum((resid(quad_model))^2))),sqrt(mean((resid(quad_model)/(1-hatvalues(quad_model)))^2)))
)
```

```{r echo=FALSE}
library(knitr)
kable(quad_model, format = "pandoc",padding = 2)
```
The RMSE LOOCV seems better than that of `Multiple Linear Regression`. We will compare at the last while making the decission around models



#####**quadriatic Transformation of the Numerical Predictors:**

```{r}
quad_model = lm(FEV ~ Age + Height + Sex + Smoker + I(Age ^ 2) + I(Height ^ 2), data = childfev)
summary(quad_model)
```

It seems the quadratic model is significance with low p value **<2e-16**, including all the predictors are significance though except `Age` where the p value is around `r summary(quad_model)$coefficientp[2,4]`

Let's check the Assumption of the model

#####**Assumption of the Model**
Let's verify the Assumption of the Model
 - Constant Varience
 - Normality 

**Let's plot Plotted Versus Residul Plot to see the distribution**
```{r}
par(mfrow = c(1,2))
plot(resid(quad_model)~fitted(quad_model), ylab = "residuals", xlab = "fitted", cex = 1, pch = 1, col = "darkgrey", main = "Residuals Versis Fitted Model - Quad")
abline(h = 0, lwd = 2, col = "darkorange")

qqnorm(resid(quad_model), cex = 1, pch = 1, col = "darkgrey")
qqline(resid(quad_model), lwd = 2, col = "darkorange")
```

From the above residuals versus fitted plot, though it seems better than that of **Multiple Linear Regression**, it's not doing good job for the higher fitted values. It seems as the fitted value goes higher, the residual seems to be wider, hence the **constant variance assumption is suspect**

This is the same case for the Q-Q plot, where both the tail seems to the a little fat tails, which tells us that **normality assuption seems suspect** for the model.

Let's do the BP Test and Shapiro Test to gather some more evidence

```{r warning=FALSE}
bptest(quad_model)
```

The BP Test is very low which confirms that **constant variance is suspect**

```{r}
shapiro.test(resid(quad_model))
```

The shapiro test also seems lkow, which confirms that the **normality assumption also seems suspect**

#####**RSS, RMSE and RMSE LOOCV**
Let'e calculate the RSS, RMSE and RMSE LOOCV of the model
**RSS**
```{r}
sum((resid(quad_model))^2)
```

**RMSE**
```{r}
sqrt(mean(sum((resid(quad_model))^2)))
```

**RMSE LOOCV**
```{r}
sqrt(mean((resid(quad_model)/(1-hatvalues(quad_model)))^2))
```

```{r include=FALSE}
quad_model = data.frame(
  Metric = c("RSS","RMSE", "RMSE LOOCV"),
  Value = c(sum((resid(quad_model))^2),sqrt(mean(sum((resid(quad_model))^2))),sqrt(mean((resid(quad_model)/(1-hatvalues(quad_model)))^2)))
)
```

```{r echo=FALSE}
library(knitr)
kable(quad_model, format = "pandoc",padding = 2)
```
The RMSE LOOCV seems better than that of `Multiple Linear Regression`. We will compare at the last while making the decission around models

